<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'">
  <title>Danh s√°ch t√†i li·ªáu - PDF Converter</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
      color: white;
      padding: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      font-size: 24px;
    }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .header .user-info {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
    }
    
    .btn-primary:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
    }
    
    .btn-secondary:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .content {
      padding: 24px;
    }
    
    .filters {
      background: #f7fafc;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 24px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: end;
    }
    
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 8px;
    }
    
    .filter-group input,
    .filter-group select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn-search {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-search:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .status-bar {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }
    
    .status-bar.show {
      display: block;
    }
    
    .status-bar.success {
      background: #c6f6d5;
      color: #276749;
    }
    
    .status-bar.error {
      background: #fed7d7;
      color: #c53030;
    }
    
    .status-bar.info {
      background: #bee3f8;
      color: #2b6cb0;
    }
    
    .documents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .document-card {
      background: #f7fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.2s;
    }
    
    .document-card:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      transform: translateY(-2px);
    }
    
    .document-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }
    
    .document-name {
      font-size: 18px;
      font-weight: 600;
      color: #2d3748;
      flex: 1;
      margin-right: 12px;
    }
    
    .document-status {
      font-size: 12px;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .document-status.uploaded {
      background: #d1fae5;
      color: #065f46;
    }
    
    .document-status.pending {
      background: #fef3c7;
      color: #92400e;
    }
    
    .document-info {
      font-size: 14px;
      color: #4a5568;
      margin-bottom: 8px;
    }
    
    .document-info strong {
      color: #2d3748;
    }
    
    .document-files {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e2e8f0;
    }
    
    .document-files-title {
      font-size: 12px;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 8px;
    }
    
    .file-tag {
      display: inline-block;
      background: white;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 12px;
      color: #4a5568;
      margin-right: 6px;
      margin-bottom: 6px;
    }
    
    .file-tag.pdf {
      background: #fee2e2;
      border-color: #fca5a5;
      color: #991b1b;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-top: 24px;
    }
    
    .pagination-btn {
      padding: 8px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      background: white;
      color: #4a5568;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .pagination-btn:hover:not(:disabled) {
      border-color: #667eea;
      color: #667eea;
    }
    
    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .pagination-info {
      font-size: 14px;
      color: #4a5568;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #718096;
      font-size: 16px;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #718096;
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }
    
    .empty-state-text {
      font-size: 18px;
      margin-bottom: 8px;
    }
    
    .empty-state-hint {
      font-size: 14px;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìö Danh s√°ch t√†i li·ªáu</h1>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="window.location.href='upload-document.html'">
          ‚ûï T·∫°o m·ªõi
        </button>
        <div class="user-info" id="userInfo"></div>
        <button class="btn btn-primary" id="logoutBtn">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>
    
    <div class="content">
      <!-- Status Bar -->
      <div id="statusBar" class="status-bar"></div>
      
      <!-- Filters -->
      <div class="filters">
        <div class="filter-group">
          <label>T√¨m ki·∫øm theo t√™n</label>
          <input type="text" id="nameFilter" placeholder="Nh·∫≠p t√™n t√†i li·ªáu...">
        </div>
        <div class="filter-group">
          <label>Lo·∫°i t√†i li·ªáu</label>
          <select id="typeFilter">
            <option value="">T·∫•t c·∫£</option>
          </select>
        </div>
        <div class="filter-group">
          <label>G√≥i</label>
          <select id="packageFilter">
            <option value="">T·∫•t c·∫£</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Danh m·ª•c</label>
          <select id="categoryFilter">
            <option value="">T·∫•t c·∫£</option>
          </select>
        </div>
        <div>
          <button class="btn-search" id="btnSearch">üîç T√¨m ki·∫øm</button>
        </div>
      </div>
      
      <!-- Documents List -->
      <div id="documentsContainer">
        <div class="loading">ƒêang t·∫£i...</div>
      </div>
      
      <!-- Pagination -->
      <div id="pagination" class="pagination" style="display: none;">
        <button class="pagination-btn" id="btnPrev" onclick="changePage(-1)">‚Üê Tr∆∞·ªõc</button>
        <span class="pagination-info" id="pageInfo"></span>
        <button class="pagination-btn" id="btnNext" onclick="changePage(1)">Sau ‚Üí</button>
      </div>
    </div>
  </div>

  <script>
    // Check authentication
    const token = localStorage.getItem('token');
    const userId = localStorage.getItem('userId');
    
    if (!token) {
      window.location.href = 'signin.html';
    }
    
    // State
    let documents = [];
    let documentTypes = [];
    let packages = [];
    let categories = [];
    let currentPage = 1;
    let totalPages = 1;
    let totalCount = 0;
    const pageSize = 10;
    
    // Filters
    let filters = {
      nameFilter: '',
      typeId: '',
      packageId: '',
      categoryId: ''
    };
    
    // DOM Elements
    const userInfo = document.getElementById('userInfo');
    const logoutBtn = document.getElementById('logoutBtn');
    const nameFilter = document.getElementById('nameFilter');
    const typeFilter = document.getElementById('typeFilter');
    const packageFilter = document.getElementById('packageFilter');
    const categoryFilter = document.getElementById('categoryFilter');
    const btnSearch = document.getElementById('btnSearch');
    const documentsContainer = document.getElementById('documentsContainer');
    const statusBar = document.getElementById('statusBar');
    const pagination = document.getElementById('pagination');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const pageInfo = document.getElementById('pageInfo');
    
    // Set user info
    userInfo.textContent = `User ID: ${userId || 'N/A'}`;
    
    // Logout
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('userId');
      window.location.href = 'signin.html';
    });
    
    // Status bar helper
    function setStatus(type, message) {
      statusBar.className = 'status-bar ' + type + ' show';
      statusBar.textContent = message;
      setTimeout(() => {
        statusBar.classList.remove('show');
      }, 5000);
    }
    
    // Load document types
    async function loadDocumentTypes() {
      try {
        const result = await window.electronAPI.getDocumentTypes(token);
        if (result.success) {
          documentTypes = result.data.types || [];
          typeFilter.innerHTML = '<option value="">T·∫•t c·∫£</option>';
          documentTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type.type_id;
            option.textContent = type.name;
            typeFilter.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading document types:', error);
      }
    }
    
    // Load packages
    async function loadPackages() {
      try {
        const result = await window.electronAPI.getPackages(token);
        if (result.success) {
          packages = result.data.packages || [];
          packageFilter.innerHTML = '<option value="">T·∫•t c·∫£</option>';
          packages.forEach(pkg => {
            const option = document.createElement('option');
            option.value = pkg.package_id;
            option.textContent = pkg.name;
            packageFilter.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading packages:', error);
      }
    }
    
    // Load categories
    async function loadCategories() {
      try {
        const result = await window.electronAPI.getDocumentCategories(token);
        if (result.success) {
          categories = result.data.categories || [];
          categoryFilter.innerHTML = '<option value="">T·∫•t c·∫£</option>';
          categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            categoryFilter.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    }
    
    // Load documents
    async function loadDocuments() {
      documentsContainer.innerHTML = '<div class="loading">ƒêang t·∫£i...</div>';
      
      try {
        const pagging = (currentPage - 1) * pageSize;
        const requestFilters = {
          ...(filters.nameFilter && { nameFilter: filters.nameFilter }),
          ...(filters.typeId && { typeId: filters.typeId }),
          ...(filters.packageId && { packageId: filters.packageId }),
          ...(filters.categoryId && { categoryId: filters.categoryId }),
          amount: pageSize,
          pagging: pagging
        };
        
        const result = await window.electronAPI.getDocuments(token, requestFilters);
        
        if (result.success) {
          documents = result.data.documents || [];
          totalCount = result.data.total_count || 0;
          totalPages = Math.max(1, Math.ceil(totalCount / pageSize));
          
          renderDocuments();
          updatePagination();
        } else {
          throw new Error(result.error || 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch t√†i li·ªáu');
        }
      } catch (error) {
        console.error('Error loading documents:', error);
        documentsContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ùå</div>
            <div class="empty-state-text">L·ªói t·∫£i danh s√°ch</div>
            <div class="empty-state-hint">${error.message || 'Vui l√≤ng th·ª≠ l·∫°i sau'}</div>
          </div>
        `;
        setStatus('error', 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch t√†i li·ªáu: ' + error.message);
      }
    }
    
    // Render documents
    function renderDocuments() {
      if (documents.length === 0) {
        documentsContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <div class="empty-state-text">Kh√¥ng c√≥ t√†i li·ªáu n√†o</div>
            <div class="empty-state-hint">H√£y t·∫°o t√†i li·ªáu m·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>
          </div>
        `;
        pagination.style.display = 'none';
        return;
      }
      
      const documentsGrid = document.createElement('div');
      documentsGrid.className = 'documents-grid';
      
      documents.forEach(doc => {
        const card = document.createElement('div');
        card.className = 'document-card';
        
        const docType = documentTypes.find(t => t.type_id === doc.type);
        const statusClass = doc.status === 'uploaded' ? 'uploaded' : 'pending';
        const statusText = doc.status === 'uploaded' ? 'ƒê√£ upload' : 'ƒêang ch·ªù';
        
        const filesHtml = doc.files.map(file => {
          const isPdf = file.file_name.toLowerCase().endsWith('.pdf');
          return `<span class="file-tag ${isPdf ? 'pdf' : ''}">${file.file_name}</span>`;
        }).join('');
        
        card.innerHTML = `
          <div class="document-header">
            <div class="document-name" title="${doc.name}">${doc.name}</div>
            <span class="document-status ${statusClass}">${statusText}</span>
          </div>
          <div class="document-info">
            <strong>ID:</strong> ${doc.document_id}
          </div>
          <div class="document-info">
            <strong>Lo·∫°i:</strong> ${docType ? docType.name : doc.type}
          </div>
          ${doc.files.length > 0 ? `
            <div class="document-files">
              <div class="document-files-title">Files (${doc.files.length}):</div>
              ${filesHtml}
            </div>
          ` : ''}
        `;
        
        documentsGrid.appendChild(card);
      });
      
      documentsContainer.innerHTML = '';
      documentsContainer.appendChild(documentsGrid);
    }
    
    // Update pagination
    function updatePagination() {
      if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
      }
      
      pagination.style.display = 'flex';
      pageInfo.textContent = `Trang ${currentPage} / ${totalPages} (${totalCount} t√†i li·ªáu)`;
      btnPrev.disabled = currentPage === 1;
      btnNext.disabled = currentPage >= totalPages;
    }
    
    // Change page
    function changePage(delta) {
      const newPage = currentPage + delta;
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        loadDocuments();
      }
    }
    
    // Search
    btnSearch.addEventListener('click', () => {
      filters.nameFilter = nameFilter.value.trim();
      filters.typeId = typeFilter.value;
      filters.packageId = packageFilter.value;
      filters.categoryId = categoryFilter.value;
      currentPage = 1;
      loadDocuments();
    });
    
    // Enter key to search
    nameFilter.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        btnSearch.click();
      }
    });
    
    // Initial load
    loadDocumentTypes();
    loadPackages();
    loadCategories();
    loadDocuments();
  </script>
</body>
</html>
